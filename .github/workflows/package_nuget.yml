name: Paquetes NPM, Pruebas y NuGet

on:
  push:
    branches: [ main ]

env:
  NODE_VERSION: '20'
  SONAR_PROJECT_KEY: proyectou_lab3nest
  SONAR_ORG_KEY: proyectou

jobs:
  build-and-publish:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write

    steps:
      - name: ðŸ§© Checkout repository
        uses: actions/checkout@v4

      - name: âš™ï¸ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: ðŸ§± Install dependencies needed on runner
        run: |
          sudo apt-get update && sudo apt-get install -y jq

      # ---------- TESTING & COVERAGE ----------
      - name: ðŸ§ª Run tests and collect coverage (payment)
        working-directory: payment
        run: |
          npm ci || npm install
          npm run test:cov

      - name: ðŸ“¦ Upload test results (payment)
        uses: actions/upload-artifact@v4
        with:
          name: payment-test-results
          path: payment/coverage

      - name: ðŸ§ª Run tests and collect coverage (atm)
        working-directory: atm
        run: |
          npm ci || npm install
          npm run test:cov

      - name: ðŸ“¦ Upload test results (atm)
        uses: actions/upload-artifact@v4
        with:
          name: atm-test-results
          path: atm/coverage

      # ---------- SONARCLOUD SCAN ----------
      - name: ðŸ” SonarCloud Scan
        uses: SonarSource/sonarcloud-github-action@v2
        with:
          projectBaseDir: .
          args: >
            -Dsonar.projectKey=${{ env.SONAR_PROJECT_KEY }}
            -Dsonar.organization=${{ env.SONAR_ORG_KEY }}
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}

      # ---------- NPM PUBLISH: PAYMENT ----------
      - name: ðŸš€ Prepare and publish payment package
        if: ${{ github.event_name == 'push' && github.ref == 'refs/heads/main' }}
        working-directory: payment
        env:
          NODE_AUTH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          jq 'del(.private) | .name = "@${{ github.repository_owner }}/payment_chire" | .version = "0.0.0-" + (env.GITHUB_RUN_NUMBER|tostring)' package.json > package.temp.json
          mv package.temp.json package.json
          npm ci || npm install
          echo "//npm.pkg.github.com/:_authToken=${NODE_AUTH_TOKEN}" > ~/.npmrc
          echo "registry=https://registry.npmjs.org/" >> ~/.npmrc
          npm publish --access=restricted --registry=https://npm.pkg.github.com/

      # ---------- NPM PUBLISH: ATM ----------
      - name: ðŸš€ Prepare and publish atm package
        if: ${{ github.event_name == 'push' && github.ref == 'refs/heads/main' }}
        working-directory: atm
        env:
          NODE_AUTH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          jq 'del(.private) | .name = "@${{ github.repository_owner }}/atm_chire" | .version = "0.0.0-" + (env.GITHUB_RUN_NUMBER|tostring)' package.json > package.temp.json
          mv package.temp.json package.json
          npm ci || npm install
          echo "//npm.pkg.github.com/:_authToken=${NODE_AUTH_TOKEN}" > ~/.npmrc
          echo "registry=https://registry.npmjs.org/" >> ~/.npmrc
          npm publish --access=restricted --registry=https://npm.pkg.github.com/

      # ---------- NUGET BUILD & PUBLISH ----------
      - name: ðŸ§± Setup .NET for NuGet
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '8.0.x'

      - name: ðŸ”¨ Restore and Build .NET project
        run: |
          dotnet restore
          dotnet build --configuration Release

      - name: ðŸ§ª Run .NET Tests
        run: dotnet test --configuration Release --no-build --verbosity normal

      - name: ðŸ“¦ Pack NuGet package
        run: dotnet pack --configuration Release --no-build --output ./nuget-packages

      - name: ðŸš€ Publish NuGet package to GitHub Packages
        run: dotnet nuget push "./nuget-packages/*.nupkg" --source "https://nuget.pkg.github.com/${{ github.repository_owner }}/index.json" --api-key "${{ secrets.GITHUB_TOKEN }}" --skip-duplicate
